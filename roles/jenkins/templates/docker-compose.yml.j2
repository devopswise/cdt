version: '2'
services:
  jenkins:
    restart: always
    image: "{{ jenkins_registry_url }}{{ jenkins_image_name }}:{{ jenkins_version }}"
    volumes:
      - "{{ docker_volumes }}/{{ jenkins_service_name }}:/var/jenkins_home"
      - '/var/run/docker.sock:/var/run/docker.sock'
    environment:
      INITIAL_ADMIN_USER: "admin"
      INITIAL_ADMIN_PASSWORD: "password" 
      LDAP_SERVER: "ldap:389"
      LDAP_ROOTDN: "cn=admin,{{ openldap_full_domain }}"
      LDAP_USER_SEARCH_BASE: "ou=people"
      LDAP_USER_SEARCH: "uid={0}"
      LDAP_GROUP_SEARCH_BASE: "ou=groups"
      LDAP_GROUP_SEARCH_FILTER: ""
      LDAP_GROUP_MEMBERSHIP_FILTER: ""
      LDAP_MANAGER_DN: "cn=admin,{{ openldap_full_domain }}"
      LDAP_MANAGER_PASSWORD: "{{ openldap_slapd_pass }}"
      LDAP_INHIBIT_INFER_ROOTDN: "false"
      LDAP_DISABLE_MAIL_ADDRESS_RESOLVER: "false"
      LDAP_DISPLAY_NAME_ATTRIBUTE_NAME: "displayName"
      LDAP_MAIL_ADDRESS_ATTRIBUTE_NAME: "mail"
    privileged: true
    networks:
      - internal
      - external
    labels:
      - traefik.backend=jenkins
      - traefik.frontend.rule=Host:jenkins.{{ base_domain }}
      - traefik.docker.network=proxy
      - traefik.port=8080
    logging:
      driver: "syslog"
      options:
        syslog-facility: "local2"
        tag: "docker/{% raw %}{{.Name}}{% endraw %}"
networks:
  internal:
    external: true
  external:
    external: true

